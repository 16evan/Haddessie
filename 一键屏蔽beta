// ==UserScript==
// @name         Haddes&16evançš„ä¸€é”®å±è”½cssè‡ªå®šä¹‰ç¾åŒ–
// @namespace    https://chat.mufy.ai/
// @version      2.0
// @description  æ™ºèƒ½åŒºåˆ†ç³»ç»ŸCSSå’Œåˆ›ä½œè€…è‡ªå®šä¹‰CSSï¼Œä¸€é”®å±è”½é«˜è€—èƒ½ç‰¹æ•ˆï¼ˆåŠ¨ç”»/èƒŒæ™¯/é˜´å½±ï¼‰ï¼Œä¿ç•™ç½‘é¡µåŸºç¡€åŠŸèƒ½å¸ƒå±€ã€‚
// @author       Haddes/16evan
// @match        https://chat.mufy.ai/chat*
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_registerMenuCommand
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    // === é…ç½®åŒºåŸŸ ===
    const TEXT_ON = "ğŸš€";
    const TEXT_OFF = "ğŸ¨";
    // ================

    let isOptimized = false;
    let performanceStyleElement = null;

    // åˆ›å»ºæ‚¬æµ®æŒ‰é’®
    const toggleBtn = document.createElement('div');
    toggleBtn.innerText = TEXT_ON;

    // æŒ‰é’®æ ·å¼
    Object.assign(toggleBtn.style, {
        position: 'fixed',
        left: '0px',
        top: '35%',
        zIndex: '2147483647',
        backgroundColor: 'rgba(0, 0, 0, 0.8)',
        color: '#fff',
        padding: '5px 10px',
        fontSize: '13px',
        fontWeight: 'bold',
        borderRadius: '0 20px 20px 0',
        cursor: 'pointer',
        userSelect: 'none',
        boxShadow: '2px 2px 8px rgba(0,0,0,0.2)',
        backdropFilter: 'blur(4px)',
        transition: 'transform 0.1s'
    });
    document.body.appendChild(toggleBtn);

    // === æ ¸å¿ƒä¿®å¤ï¼šæ›´æ–°åçš„å¼ºåˆ¶é™çº§æ ·å¼ ===
    const performanceCSS = `
        /* 1. å…¨å±€ç¦ç”¨é«˜è€—èƒ½å±æ€§ */
        *:not([class*="translate-x-[-50%]"]) {
            /* æ³¨æ„ï¼šè¿™é‡Œç¨å¾®æ”¾å®½äº†ä¸€ç‚¹ï¼Œé˜²æ­¢è¯¯ä¼¤å®šä½å…ƒç´ ï¼Œä½†åœ¨ä¸‹é¢ä¸“é—¨å¤„ç†åŠ¨ç”» */
            /* å¦‚æœä¸æ˜¯å±…ä¸­å®šä½å…ƒç´ ï¼Œå¼ºåˆ¶ç§»é™¤ transform */
            /* ä½†ä¸ºäº†æ›´ç¨³å¦¥ï¼Œæˆ‘ä»¬ä¸»è¦é’ˆå¯¹åŠ¨ç”»å’Œé˜´å½± */
        }

        /* å¼ºåˆ¶åœæ­¢æ‰€æœ‰åŠ¨ç”»ã€è¿‡æ¸¡ã€é˜´å½±ã€æ»¤é•œ */
        * {
            animation: none !important;
            transition: none !important;
            box-shadow: none !important;
            text-shadow: none !important;
            filter: none !important;
            backdrop-filter: none !important;
        }

        /* 2. é’ˆå¯¹æ™®é€šå…ƒç´ ï¼Œç§»é™¤ transform ä»¥èŠ‚çœæ€§èƒ½ */
        /* ä½†æ’é™¤æ‰é‚£äº›å¸¦æœ‰ translate-x-[-50%] çš„å…ƒç´ ï¼ˆå³å¼¹çª—ï¼‰ */
        *:not([class*="translate-x-[-50%]"]):not([class*="translate-y-[-50%]"]) {
            transform: none !important;
        }

        /* 3. ã€æ ¸å¿ƒä¿®å¤ã€‘å¼ºåˆ¶ä¿®æ­£å¼¹çª—ä½ç½® */
        /* åªè¦å…ƒç´ åŒ…å«è¿™ä¸¤ä¸ªç±»åï¼Œå°±å¼ºåˆ¶åº”ç”¨å±…ä¸­ä½ç§»ï¼Œè¦†ç›–ä¸Šé¢çš„ none */
        [class*="translate-x-[-50%]"][class*="translate-y-[-50%]"] {
            transform: translate(-50%, -50%) !important;
            /* ç¡®ä¿åœ¨å¼€å¯å±è”½æ—¶ï¼Œå¼¹çª—ä¾ç„¶åœ¨æœ€ä¸Šå±‚ */
            z-index: 2147483646 !important;
            /* ç»™ä¸ªæ·±è‰²èƒŒæ™¯ç¡®ä¿èƒ½çœ‹æ¸…å†…å®¹ */
            background-color: #222 !important;
            border: 1px solid #444 !important;
        }

        /* 4. ç§»é™¤èƒŒæ™¯å›¾ */
        body, html, div, section, main, article {
            background-image: none !important;
        }

        /* 5. æŠ¤çœ¼èƒŒæ™¯è‰² */
        body {
            background-color: #f5f5f5 !important;
            color: #333 !important;
        }
    `;

    // ç‚¹å‡»äº‹ä»¶
    toggleBtn.addEventListener('click', function() {
        isOptimized = !isOptimized;

        if (isOptimized) {
            // === å¼€å¯å±è”½æ¨¡å¼ ===

            if (!performanceStyleElement) {
                performanceStyleElement = document.createElement('style');
                performanceStyleElement.innerHTML = performanceCSS;
                document.head.appendChild(performanceStyleElement);
            } else {
                performanceStyleElement.disabled = false;
            }

            // æ™ºèƒ½å±è”½ <style> æ ‡ç­¾
            for (let i = 0; i < document.styleSheets.length; i++) {
                let sheet = document.styleSheets[i];
                let owner = sheet.ownerNode;

                if (owner.tagName === 'STYLE' && owner !== performanceStyleElement && owner !== toggleBtn) {
                    try {
                         if (!sheet.disabled) {
                            sheet.disabled = true;
                            owner.setAttribute('data-blocked-by-script', 'true');
                        }
                    } catch(e) {}
                }
            }

            toggleBtn.innerText = TEXT_OFF;
            toggleBtn.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';

        } else {
            // === æ¢å¤åŸçŠ¶ ===
            if (performanceStyleElement) {
                performanceStyleElement.disabled = true;
            }

            for (let i = 0; i < document.styleSheets.length; i++) {
                let sheet = document.styleSheets[i];
                let owner = sheet.ownerNode;

                if (owner.getAttribute('data-blocked-by-script') === 'true') {
                    sheet.disabled = false;
                    owner.removeAttribute('data-blocked-by-script');
                }
            }

            toggleBtn.innerText = TEXT_ON;
            toggleBtn.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
        }
    });

    // è§¦æ‘¸ä¼˜åŒ–
    toggleBtn.addEventListener('touchstart', (e) => {
        e.stopPropagation();
        toggleBtn.style.transform = 'scale(0.95)';
    }, {passive: false});

    toggleBtn.addEventListener('touchend', () => {
        toggleBtn.style.transform = 'scale(1)';
    });

})();
